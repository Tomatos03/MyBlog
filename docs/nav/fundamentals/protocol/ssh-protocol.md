# SSH

SSH (Secure Shell) 是一种网络协议，用于在不安全的网络中安全地访问远程计算机。它通过加密技术确保通信的机密性和完整性。

## 工作流程
这里仅介绍最常见的基于公钥和私钥的 SSH 连接流程：

```mermaid
sequenceDiagram
    participant 用户 as 用户
    participant 客户端 as SSH客户端
    participant 服务器 as SSH服务器

    Note over 用户,客户端: 前置条件：公钥已配置到服务器
    用户->>客户端: ssh-keygen 生成密钥对
    用户->>服务器: 将公钥添加到 ~/.ssh/authorized_keys

    Note over 客户端,服务器: 阶段一：连接建立
    用户->>客户端: 输入 ssh user@hostname
    客户端->>服务器: TCP连接请求 (端口22)
    服务器-->>客户端: 发送服务器公钥和版本
    
        alt 首次连接该服务器
        客户端->>客户端: 在known_hosts中未找到该服务器记录
        客户端-->>用户: 显示服务器指纹和警告
        用户->>客户端: 确认是否信任该服务器 (yes/no)
        
        alt 用户选择信任
            客户端->>客户端: 将服务器公钥添加到known_hosts
            客户端->>服务器: 继续连接流程
        else 用户选择不信任
            客户端->>客户端: 终止连接
            客户端-->>用户: 连接中止
        end
        
    else 已连接过该服务器
        客户端->>客户端: 验证服务器公钥与known_hosts匹配
        alt 公钥匹配
            客户端->>服务器: 继续连接流程
        else 公钥不匹配 (可能中间人攻击)
            客户端-->>用户: 显示安全警告和指纹变化
            客户端->>客户端: 终止连接
            客户端-->>用户: 连接中止，建议检查
        end
    end

    Note over 客户端,服务器: 阶段二：密钥交换
    客户端->>服务器: 协商加密算法 (Diffie-Hellman)
    服务器-->>客户端: 确认算法，生成会话密钥
    
    Note right of 客户端: 从此刻起所有通信都加密

    Note over 客户端,服务器: 阶段三：公钥认证
    客户端->>服务器: 发送用户名和公钥指纹
    服务器-->>客户端: 挑战请求 (随机数)
    
    客户端->>客户端: 使用私钥对挑战进行签名
    客户端->>服务器: 发送加密的签名响应
    
    服务器->>服务器: 使用存储的公钥验证签名
    服务器-->>客户端: 认证成功

    Note over 客户端,服务器: 阶段四：加密通道建立
    服务器-->>客户端: 确认建立加密会话通道
    Note right of 服务器: 使用会话密钥加密所有通信

    Note over 客户端,服务器: 阶段五：安全通信
    客户端->>服务器: 发送加密的命令请求
    服务器->>服务器: 解密并执行命令
    服务器-->>客户端: 返回加密的执行结果

    loop 持续安全交互
        客户端->>服务器: 加密数据传输
        服务器-->>客户端: 加密响应返回
    end

    Note over 用户,客户端: 阶段六：连接终止
    用户->>客户端: 输入 exit 或 Ctrl+D
    客户端->>服务器: 发送加密的断开请求
    服务器-->>客户端: 确认断开连接
    客户端-->>用户: 显示连接已关闭
```


## 身份验证方式

SSH 通常使用以下方式进行身份验证：

1. **公钥和私钥**: 通过生成密钥对，确保只有拥有私钥的用户可以访问。
2. **用户名和密码**: 提供传统的验证方式，但安全性较低。

SSH 是管理远程服务器和保护网络通信的关键工具，广泛应用于开发、运维和网络管理领域。

## 公钥和私钥

公钥和私钥是非对称加密中的一对密钥，用于确保数据的安全性和完整性

1. **公钥**: 可以公开分发的密钥，用于加密数据或验证数字签名。
2. **私钥**: 必须保密的密钥，用于解密数据或生成数字签名。

常见用途:
1. 私钥对需要发送的消息进行数字签名, 公钥对签名进行验证, 能够确保消息的完整性和真实性, 但不保证消息不被窃听
2. 公钥对消息进行加密, 私钥对加密的消息进行解密, 能够确保消息的机密性, 但不保证消息的完整性和和真实性(因为公钥是公开的)

安全通信流程如下：
1. **发送方用接收方公钥加密消息**（保证只有接收方能解密，防窃取）。
2. **发送方用自己的私钥对消息签名**（保证消息确实来自发送方，防篡改）。
3. **接收方收到消息后：**
   - 用自己的私钥解密（获得明文）。
   - 用发送方公钥验证签名（确认来源和完整性）。
